# PyBook

This project has a few parts.

First part is a containerized build of Python inside emscripten. This allows running Python in the browser locally.

The version here has a few tweaks to allow better integration of the Python interpreter with the web environment. Most
notably, it has tweaks to allow keyboard interrupt using a JavaScript callback function inside the main interpreter loop.
This replaces control-C style interrupts which are not generated by the emscripten environment.

The interpreter can also dynamically load python modules.

Second big part is a notebook interface using the kernel to allow Python notebooks similar to Mathematica.

## Developing

If things are in a good state, you should be able to do:

    make

This should create a container, build Python in emscripten, build necessary libraries and tools, and package everything
in the `build` directory.

To run PyBook in your browser, do:

    make serve

It will start a mini server, in a browser go to `localhost:8063/pybook.html`.

## PyBook UI

You have cells, cells can be Python code or Markdown. To run Python code, use "Control-Enter".
Output from the evaluation will be shown after a small right arrow. Things printed to `stdout` will appear before the evaluated output.

For PyBook, even if the expression evaluates to `None` that will be shown with the arrow. This is a slight difference from the
command-line Python interpreter.

Note that when you import modules, you may be sending requests to the web server.

## Features

### Status Lights

There are three lights showing kernel status.

First is kernel active. This lights up when the main interpreter loop is active doing something.

Second is loading. This lights up when files are being loaded, which normally happens when modules are imported.

Third is bootup. This lights up when the kernel is first started up, and turns off when the kernel is ready.

Example that shows loading (first time evaluated):

    import png
    help(png)

### Sleep

You can do `time.sleep` to delay in Python. This should not break the browser. The Python kernel itself is not multi-threaded, so if you start evaluating one cell and it sleeps, you will need to interrupt it to evaluate more cells in other positions.

Example:

    import time
    for i in range(10):
        print(i)
        time.sleep(1)

### Interrupt

Press "Control-C" to interrupt computation or sleep in a cell. This should normally generate a `KeyboardInterrupt` exception. If you catch this exception and don't exit it is possible to lockup the Python kernel.

### PyBook Module

There is a special Python module `pybook` that has functions to interact with the notebook. This lets you write Python code to generate images or HTML or whatever you want.

Example:

    import pybook
    pybook.output_text_content("text/html", "<b>Hello</b>")

## Internals

* cpython/
    * Build instructions for compiling Python in emscripten.
    * Includes patches to make build work.
    * Includes patches to support some hooks into eval function.
* kernel/
    * Source code for C++ kernel that uses Python.
    * Includes `pybook` module directly in C++ source.
    * This kernel is the main function that is compiled into Web Assembly.
    * Includes list of libraries to be pre-loaded that are required to load Python modules from zip archives.
* web/
    * Symbolic links to built wasm output
    * lib/
        * UI libraries needed for notebook interface
    * src/
        * JavaScript modules for Python evaluation, worker threads, notebook UI
    * gfx/
        * Minor graphics stuff for web interface
* localroot/
    * Python files available to kernel in notebook outside of Python standard libraries.
* Makefile
    * Top level makefile for everything

## Bare Build

You can build outside of the docker container. You'll need the various prerequisites listed
in the Dockerfile. One important one that is not obvious is `libffi-dev`. If you don't have this and try to build, you will need to clean up after installing it and rebuild from scratch.

To build the main python interpreter:

    cd cpython
    make

To build packages (from main project directory):

    export PATH=`pwd`/cpython/build/3.9.5/host/bin:$PATH
    cd packages/PyCExtension
    python3 -m pyodide_build pywasmcross
    chmod a+x ../../tools/*

### Notes on numpy source changes

tp_print updated to tp_vectorcall blah
sse is being annoying, tried to enable in emcc with -msse -msse2 -msimd128 but hit errors
Solution is copying config.h file already in archive.

Need to add -L to get libs, not sure why.
    -Lbuild/temp.linux-x86_64-3.9 

GRRR, final build is working and packaged into `numpy.zip` but Python wasm version doesn't have dlopen turned on. Tried to load `_dummy.so` module directly but got error:

    import sys
    sys.path=['/python3.9.zip', '/localroot.zip', '/numpy.zip', '/']
    import _dummy

    To use dlopen, you need to use Emscripten's linking support, see https://github.com/emscripten-core/emscripten/wiki/Linking
