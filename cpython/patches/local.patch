From 4604226f96d234966d21cb28a04103015d220e1b Mon Sep 17 00:00:00 2001
From: Nathan Whitehead <nwhitehe@gmail.com>
Date: Sun, 9 May 2021 17:07:39 -0600
Subject: [PATCH] Patch1

---
 Lib/platform.py                   |  2 +-
 Lib/test/support/__init__.py      |  2 ++
 Lib/test/support/script_helper.py |  5 +++++
 Modules/socketmodule.h            |  2 ++
 Modules/timemodule.c              | 12 ++++++++++++
 Python/ceval.c                    | 14 ++++++++++++++
 Python/fileutils.c                |  4 ++++
 config.sub                        |  6 +++++-
 configure                         |  6 ++++++
 configure.ac                      |  6 ++++++
 10 files changed, 57 insertions(+), 2 deletions(-)

diff --git a/Lib/platform.py b/Lib/platform.py
index 0bce438..8fdfe05 100755
--- a/Lib/platform.py
+++ b/Lib/platform.py
@@ -614,7 +614,7 @@ def _syscmd_file(target, default=''):
         default in case the command should fail.
 
     """
-    if sys.platform in ('dos', 'win32', 'win16'):
+    if sys.platform in ('dos', 'win32', 'win16', 'emscripten'):
         # XXX Others too ?
         return default
 
diff --git a/Lib/test/support/__init__.py b/Lib/test/support/__init__.py
index aee3737..d0be99f 100644
--- a/Lib/test/support/__init__.py
+++ b/Lib/test/support/__init__.py
@@ -809,6 +809,8 @@ if os.name == 'nt':
                   'Unicode filename tests may not be effective'
                   % (TESTFN_UNENCODABLE, TESTFN_ENCODING))
             TESTFN_UNENCODABLE = None
+elif sys.platform == 'emscripten':
+    pass
 # Mac OS X denies unencodable filenames (invalid utf-8)
 elif sys.platform != 'darwin':
     try:
diff --git a/Lib/test/support/script_helper.py b/Lib/test/support/script_helper.py
index 37e576d..b68031a 100644
--- a/Lib/test/support/script_helper.py
+++ b/Lib/test/support/script_helper.py
@@ -9,6 +9,7 @@ import os.path
 import subprocess
 import py_compile
 import zipfile
+import unittest
 
 from importlib.util import source_from_cache
 from test.support import make_legacy_pyc
@@ -34,6 +35,8 @@ def interpreter_requires_environment():
     situation.  PYTHONPATH or PYTHONUSERSITE are other common environment
     variables that might impact whether or not the interpreter can start.
     """
+    raise unittest.SkipTest('no subprocess')
+
     global __cached_interp_requires_environment
     if __cached_interp_requires_environment is None:
         # If PYTHONHOME is set, assume that we need it
@@ -171,6 +174,8 @@ def spawn_python(*args, stdout=subprocess.PIPE, stderr=subprocess.STDOUT, **kw):
     kw is extra keyword args to pass to subprocess.Popen. Returns a Popen
     object.
     """
+    raise unittest.SkipTest('no subprocess')
+
     cmd_line = [sys.executable]
     if not interpreter_requires_environment():
         cmd_line.append('-E')
diff --git a/Modules/socketmodule.h b/Modules/socketmodule.h
index ba2c9f5..5640169 100644
--- a/Modules/socketmodule.h
+++ b/Modules/socketmodule.h
@@ -199,6 +199,8 @@ typedef int socklen_t;
 extern "C" {
 #endif
 
+#undef AF_VSOCK
+
 /* Python module and C API name */
 #define PySocket_MODULE_NAME    "_socket"
 #define PySocket_CAPI_NAME      "CAPI"
diff --git a/Modules/timemodule.c b/Modules/timemodule.c
index 80eab30..c9fdd7d 100644
--- a/Modules/timemodule.c
+++ b/Modules/timemodule.c
@@ -62,6 +62,14 @@
 
 #define SEC_TO_NS (1000 * 1000 * 1000)
 
+#include "emscripten.h"
+EM_JS(int, PYJS_Sleep, (double t), {
+    if (typeof JS_Sleep === 'function') {
+        return JS_Sleep(t);
+    }
+    return 0;
+});
+
 /* Forward declarations */
 static int pysleep(_PyTime_t);
 
@@ -2014,6 +2022,9 @@ PyInit_time(void)
 static int
 pysleep(_PyTime_t secs)
 {
+#ifdef __EMSCRIPTEN__
+    return PYJS_Sleep(_PyTime_AsSecondsDouble(secs));
+#else
     _PyTime_t deadline, monotonic;
 #ifndef MS_WINDOWS
     struct timeval timeout;
@@ -2085,4 +2096,5 @@ pysleep(_PyTime_t secs)
     } while (1);
 
     return 0;
+#endif
 }
diff --git a/Python/ceval.c b/Python/ceval.c
index 91e879e..048e3fc 100644
--- a/Python/ceval.c
+++ b/Python/ceval.c
@@ -1,3 +1,13 @@
+#include "emscripten.h"
+
+EM_JS(int, PYJS_KeyboardInterrupt, (void), {
+    if (typeof JS_KeyboardInterrupt === 'function') {
+        if (JS_KeyboardInterrupt()) {
+            return 1;
+        }
+    }
+    return 0;
+});
 
 /* Execute compiled code */
 
@@ -1373,6 +1383,10 @@ main_loop:
            event needs attention (e.g. a signal handler or
            async I/O handler); see Py_AddPendingCall() and
            Py_MakePendingCalls() above. */
+        if (PYJS_KeyboardInterrupt()) {
+            PyErr_SetString(PyExc_KeyboardInterrupt, "");
+            goto error;
+        }
 
         if (_Py_atomic_load_relaxed(eval_breaker)) {
             opcode = _Py_OPCODE(*next_instr);
diff --git a/Python/fileutils.c b/Python/fileutils.c
index 769ab59..e3213f0 100644
--- a/Python/fileutils.c
+++ b/Python/fileutils.c
@@ -1134,6 +1134,9 @@ _Py_get_inheritable(int fd)
 static int
 set_inheritable(int fd, int inheritable, int raise, int *atomic_flag_works)
 {
+#ifdef EMSCRIPTEN
+    return 0;
+#else
 #ifdef MS_WINDOWS
     HANDLE handle;
     DWORD flags;
@@ -1264,6 +1267,7 @@ set_inheritable(int fd, int inheritable, int raise, int *atomic_flag_works)
     }
     return 0;
 #endif
+#endif
 }
 
 /* Make the file descriptor non-inheritable.
diff --git a/config.sub b/config.sub
index ba37cf9..7586055 100755
--- a/config.sub
+++ b/config.sub
@@ -118,7 +118,8 @@ case $maybe_os in
   linux-musl* | linux-uclibc* | uclinux-uclibc* | uclinux-gnu* | kfreebsd*-gnu* | \
   knetbsd*-gnu* | netbsd*-gnu* | netbsd*-eabi* | \
   kopensolaris*-gnu* | cloudabi*-eabi* | \
-  storm-chaos* | os2-emx* | rtmk-nova*)
+  storm-chaos* | os2-emx* | rtmk-nova* | \
+  emscripten)
     os=-$maybe_os
     basic_machine=`echo "$1" | sed 's/^\(.*\)-\([^-]*-[^-]*\)$/\1/'`
     ;;
@@ -250,6 +251,7 @@ case $basic_machine in
 	| am33_2.0 \
 	| arc | arceb \
 	| arm | arm[bl]e | arme[lb] | armv[2-8] | armv[3-8][lb] | armv6m | armv[78][arm] \
+        | asmjs \
 	| avr | avr32 \
 	| ba \
 	| be32 | be64 \
@@ -1522,6 +1524,8 @@ case $os in
 			;;
 		esac
 		;;
+        -emscripten)
+                ;;
 	-nacl*)
 		;;
 	-ios)
diff --git a/configure b/configure
index 8dcdbf1..9a104ef 100755
--- a/configure
+++ b/configure
@@ -3304,6 +3304,9 @@ then
 	*-*-cygwin*)
 		ac_sys_system=Cygwin
 		;;
+	asmjs-*-*)
+		ac_sys_system=Emscripten
+		;;
 	*-*-vxworks*)
 	    ac_sys_system=VxWorks
 	    ;;
@@ -3354,6 +3357,9 @@ if test "$cross_compiling" = yes; then
 	*-*-cygwin*)
 		_host_cpu=
 		;;
+	asmjs-*-*)
+		_host_cpu=
+		;;
 	*-*-vxworks*)
 		_host_cpu=$host_cpu
 		;;
diff --git a/configure.ac b/configure.ac
index b1e4c6c..0be42b4 100644
--- a/configure.ac
+++ b/configure.ac
@@ -400,6 +400,9 @@ then
 	*-*-cygwin*)
 		ac_sys_system=Cygwin
 		;;
+	asmjs-*-*)
+		ac_sys_system=Emscripten
+		;;
 	*-*-vxworks*)
 	    ac_sys_system=VxWorks
 	    ;;
@@ -449,6 +452,9 @@ if test "$cross_compiling" = yes; then
 	*-*-cygwin*)
 		_host_cpu=
 		;;
+	asmjs-*-*)
+		_host_cpu=
+		;;
 	*-*-vxworks*)
 		_host_cpu=$host_cpu
 		;;
-- 
2.25.1

