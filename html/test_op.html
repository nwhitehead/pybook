<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>CPyton Emscripten Test</title>

<script src="spawn.js"></script>

<script>


var worker = spawn({
  setup: function() {
    // Emscripten asm.js file needs to load data file
    // Inside Web Worker the url needs to be absolute
    console.log('Worker setup');
    if (typeof(Module) === "undefined") Module = {};
    Module.locateFile = function(path, prefix) {
        return config.absurl + '/' + path;
    };
    list = ['random', 'warnings', 'types', 'functools', 'collections'];
    Module["preInit"] = function() {
        FS.mkdir('/lib');
        FS.mkdir('/lib/python3.5');
        for (var i = 0; i < list.length; i++) {
            var elem = list[i];
            FS.createLazyFile('/lib/python3.5', elem + '.py', config.absurl + '/lib/python3.5/' + elem + '.py', true, false);
        }
    };
    importScripts(config.absurl + '/python.asm.js');
    Kernel_new = Module.cwrap('Kernel_new', 'number', []);

    program = '\
    import os                                           \n\
                                                        \n\
    for dirname, dirnames, filenames in os.walk(\'/lib\'):   \n\
        # print path to all subdirectories first.       \n\
        for subdirname in dirnames:                     \n\
            print(os.path.join(dirname, subdirname))    \n\
                                                        \n\
        # print path to all filenames.                  \n\
        for filename in filenames:                      \n\
            print(os.path.join(dirname, filename))      \n\
                                                        \n\
    with open("/lib/python3.5/abc.py") as f:            \n\
        print(f.read())                                 \n\
    with open("/lib/python3.5/random.py") as f:         \n\
        print(f.read())                                 \n\
    ';

    // Wait for the module to be ready before calling any functions.
    var interval = setInterval(function () {
        if (Module.calledRun) {
            clearInterval(interval);
            console.log('Worker ready');
            send({ type:'ready' });
        }
    }, 100);
  },
  fn: function(input, done) {
    console.log('Worker got a message', input);
    if (input.type === 'execute') {
        if (!Module.calledRun)
        {
            console.log('Not ready yet');
            done({ type:'notready' });
        } else {
            console.log('Ready for python');
            var result = customEval(input.data);
            console.log('PyRun_String result', result);
            done({ type: 'response', data: result });
        }
    } else {
        throw 'Unknown message type in webworker onmessage';
    }
  },
  config: {
      absurl: document.location.protocol + '//' + document.location.host
  }
});

worker.on('message', function(msg) {
    console.log('Main thread got a message', msg);
    if (msg.type === 'ready') {
        console.log('Sending a python request');
        worker.send({ type:'execute', data:'print("42")' });
    } else if (msg.type === 'response') {
        console.log('Got response');
    } else {
        console.log('Unknown response in main thread onmessage', msg);
        throw 'Unknown response in main thread onmessage';
    }
});

        </script>

</head>
<body>

</body>
</html>
