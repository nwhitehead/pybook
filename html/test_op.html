<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>CPyton Emscripten Test</title>

<script>

function createWorker(fn) {
    // Set variable inside Blob to record absolute url to here
    var absurl = document.location.protocol + '//' + document.location.host;
    var blob = new Blob(['self.absurl = "', absurl, '";', 'self.onmessage = ', fn.toString()], { type: 'text/javascript' });
    var url = URL.createObjectURL(blob);
    return new Worker(url);
}

var worker = createWorker(function(e) {
    // Emscripten asm.js file needs to load data file
    // Inside Web Worker the url needs to be absolute
    Module = {};
    Module.locateFile = function(path, prefix) {
        return absurl + '/' + path;
    };
    importScripts(absurl + '/python.asm.js');
    const pyexec = Module.cwrap('PyRun_SimpleString', 'number', ['string']);
    console.log('Worker got a message', e);
    postMessage('response');
});

worker.onmessage = function(e) {
    console.log('Main thread got response', e);
};
worker.postMessage('Message');

            //~ const spawn = threads.spawn;
            
            
            //~ const worker = spawn(function() {});
            
            //~ console.log(document.currentScript.src);
            //~ worker
                //~ .run(function(input, done) {
                    //~ console.log('Worker thread starting up');
                    //~ console.log('Got input url: ', input.url);
//~ //                    importScripts('/python.asm.js');
//~ //                    importScripts('http://localhost:8063/python.asm.js');
//~ //                    importScripts(input.url + '//' + 'python.asm.js');
                    //~ const pyexec = Module.cwrap('PyRun_SimpleString', 'number', ['string']);

                    //~ done({ integer : parseInt(input.string) });
                //~ })
                //~ .send({url: document.location.protocol + '//' + document.location.host});

//                    done({ integer : parseInt(input.string) });

            //~ var onReady = function() {
                //~ console.log('Running a python statement using pyexec();');
                //~ pyexec('print("Success!")');
                //~ console.log('Sending worker 5');
                //~ worker
                    //~ .send({ string : '5' })
                    //~ .on('message', function(response) {
                        //~ console.log('Got response ', response.integer);
                    //~ })
                    //~ .on('error', function(error) {
                        //~ console.log('Worker got error ', error);
                    //~ })
                    //~ .on('exit', function() {
                        //~ console.log('Worker exited');
                    //~ })                    
            //~ };

            // Wait for the module to be ready before calling any functions.
            //~ var interval = setInterval(function () {
                //~ if (Module.calledRun) {
                    //~ window.clearInterval(interval);
                    //~ onReady();
                //~ }
            //~ }, 100);
        </script>

</head>
<body>

<p>This is a test.</p>

</body>
</html>
