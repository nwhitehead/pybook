<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>CPyton Emscripten Test</title>

<script src="codemirror/codemirror.js"></script>
<link rel="stylesheet" href="codemirror/codemirror.css">
<script src="codemirror/python.js"></script>

<style>
#status {
    display: flex;
    width: 100%;
    height: 32px;
    margin: 10px;
}
div#status p {
    padding: 0;
    margin: 0;
    font-size: 10pt;
    font-family: monospace;
}
.app {
    font-size: 14px;
}
.cell {
    border: 1px solid #000;
}
.input.CodeMirror {
    border: 2px solid #888;
    height: auto;
}
.output {
    background-color: #fffcfa;
    border: 2px solid #888;
    height: auto;
}
.evaloutput {
    background-color: #fafcff;
    border: 2px solid #888;
    height: auto;
}
.stdout {
}
.stderr {
    background-color: #ff0;
}
.eval {
}
pre {
    white-space: pre-wrap;
    word-break: break-all;
    margin: 0;
}
.led {
    width: 16px;
    height: 16px;
    background-image: url('gfx/led-sprite-small.png');
    background-position: 0px -128px;
}
.led.on {
    background-position: 0px -144px;
}
</style>

</head>
<body>

<div id='status'>
<div id='busy' class='led'></div>
<div id='loading' class='led'></div>
<div id='starting' class='led'></div>
</div>

<div id='app' class='app'>
<div class='cell'>
<textarea id='inputarea' class='input'></textarea>
<div id='outputarea' class='output'></div>
<div id='evaloutputarea' class='evaloutput'></div>
</div>
</div>

<script type="module">

import { onready } from './onready.js'

// Empty a DOM element of all contents
function empty(element) {
    while (element.firstChild) {
        element.removeChild(element.firstChild);
    }
    return element;
};

// Given string with possible HTML, sanitize it to be raw text
function escapeHTML(unsafe) {
    return unsafe
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
}

import { signalMap,
         isBusy,
         isStarting, setStarting,
         setInterrupt, clearInterrupt
       } from './signal.js';
import { newPythonKernel } from './python.js';

onready(function() {

    var inputarea = CodeMirror.fromTextArea(document.getElementById('inputarea'));
    var outputarea = document.getElementById('outputarea');
    var evaloutputarea = document.getElementById('evaloutputarea');
    
    inputarea.getWrapperElement().classList.add('input');

    var opts = {
        onStdout: function(msg) {
            var elem = document.createElement('pre');
            elem.innerHTML = escapeHTML(msg);
            elem.classList.add('stdout');
            outputarea.appendChild(elem);
        },
        onStderr: function(msg) {
            var elem = document.createElement('pre');
            elem.classList.add('stderr');
            elem.innerHTML = escapeHTML(msg);
            outputarea.appendChild(elem);
        },
        onOutput: function(content_type, data) {
            if (content_type === 'text/html') {
                var elem = document.getElementById('outputarea');
                elem.innerHTML = data;
            } else if (content_type === 'text/plain') {
                var elem = document.getElementById('outputarea');
                elem.innerHTML = '<pre>' + data + '</pre>';
            } else if (content_type === 'image/png') {
                var elem = document.getElementById('outputarea');
                var img = document.createElement('img');
                elem.appendChild(img);
                var blob = new Blob([data], { type:'image/png' });
                var urlCreator = window.URL || window.webkitURL;
                var imageUrl = urlCreator.createObjectURL(blob);
                img.src = imageUrl;
            } else {
                console.log('Unknown content_type ' + content_type);
            }
        },
        onResponse: function(msg) {
            var elem = document.createElement('pre');
            elem.classList.add('eval');
            elem.innerHTML = escapeHTML(msg);
            evaloutputarea.appendChild(elem);
        },
        onFilesystem: function() {
            var elem = document.getElementById('loading');
            elem.classList.add('on');
            setTimeout(function() {
                elem.classList.remove('on');
            }, 200);
        },
    };

    var python = newPythonKernel(opts);

    inputarea.setOption('extraKeys', {
        'Ctrl-Enter': function(cm) {
            if (!isBusy()) {
                // Clear flag to indicate keyboard interrupt
                clearInterrupt();
                empty(outputarea);
                empty(evaloutputarea);
                python.evaluate(inputarea.doc.getValue());
            } else {
                console.log('Kernel is busy');
            }
        },
        'Ctrl-R': function(cm) {
            console.log('Kernel reset');
            setStarting();
            python.reset();
        },
        'Ctrl-C': function(cm) {
            // Set flag to indicate keyboard interrupt
            setInterrupt();
        }
    });
    
    setInterval(function() {
        var elem = document.getElementById('busy');
        if (isBusy()) {
            elem.classList.add('on');
        } else {
            elem.classList.remove('on');
        }
        var elem = document.getElementById('starting');
        if (isStarting()) {
            elem.classList.add('on');
        } else {
            elem.classList.remove('on');
        }
    }, 100);

});

</script>

</body>
</html>
