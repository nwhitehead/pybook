<!DOCTYPE html>
<html>
<head>
<title>Test of VueJS Notebook</title>
<script defer src="codemirror/codemirror.js"></script>
<link rel="stylesheet" href="codemirror/codemirror.css">
<script defer src="codemirror/python.js"></script>
<style>
.cell {
    border: 1px solid #000;
}
.input.CodeMirror {
    border: 1px solid #000;
    height: auto;
}
.output {
    background-color: #fffcfa;
    border: 2px solid #888;
    height: auto;
}
.evaloutput {
    background-color: #fafcff;
    border: 2px solid #888;
    height: auto;
}
.stdout {
}
.stderr {
    background-color: #ff0;
}
.eval {
}
pre {
    white-space: pre-wrap;
    word-break: break-all;
    margin: 0;
}

</style>
</head>
<body>


<div id="app">
    <cell
        v-bind:value="txt"
        v-bind:output="out"
        :id="0"
        v-on:update:value="handleInput"
        v-on:action="handleAction"
    >
    </cell>
    <pre>{{ JSON.stringify(notebook, null, 2) }}</pre>
</div>

<script defer src="vue.js"></script>
<script defer src="vuex.js"></script>

<script>

function onready(f) {
    if (window.onload) {
        var curronload = window.onload;
        var newonload = function(evt) {
            curronload(evt);
            f(evt);
        };
        window.onload = newonload;
    } else {
        window.onload = f;
    }
}

onready(function() {
    Vue.component('codemirror', {
        props: ['options', 'value', 'id'],
        template: String.raw`
            <div class="input">
                <textarea></textarea>
            </div>`,
        mounted: function() {
            var self = this;
            var elem = self.$el.querySelector('textarea');
            self.editor = CodeMirror.fromTextArea(elem, self.options);
            self.editor.getWrapperElement().classList.add('input');
            self.editor.setValue(self.value || '');
            self.editor.on('change', function(cm) {
                self.$emit('update:value', cm.getValue());
            });
            self.editor.setOption('extraKeys', {
                'Ctrl-Enter': function(cm) {
                    self.$emit('action', { id:self.id, action:'eval' });
                },
                'Ctrl-C': function(cm) {
                    self.$emit('action', { id:self.id, action:'break' });
                },
            });
        },
        watch: {
            value: function(v) {
                var currentValue = this.editor.getValue();
                if (currentValue !== v) {
                    this.editor.setValue(v);
                }
            },
        },
    });
    Vue.component('celloutput', {
        props: ['values'],
        template: String.raw`
<div class="output">
    <pre v-for="value in values" :class="value.type">{{ value.contents }}</pre>
</div>
`
    });
    Vue.component('cell', {
        props: ['value', 'output', 'id'],
        template: String.raw`
            <div class="cell">
                <codemirror
                    v-bind:value="value"
                    v-on:update:value="handleInput"
                    v-on:action="handleAction"
                    >
                </codemirror>
                <celloutput
                    v-bind:values="output"
                >
                </celloutput>
            </div>`,
        methods: {
            handleInput (event) {
                this.$emit('update:value', { id:this.id, value:event });
            },
            handleAction (event) {
                this.$emit('action', { id:this.id, action:event.action });
            },
        }
    });
    const store = new Vuex.Store({
        state: {
            cells: [
                {
                    cell_type: 'code',
                    execution_count: 1,
                    source: '# some python code here\n2 + 2\n',
                    outputs: [],
                },
                {
                    cell_type: 'code',
                    execution_count: 1,
                    source: '2 ** 10\n',
                    outputs: [],
                }
            ],
        },
        mutations: {
            setSource (state, payload) {
                Vue.set(state.cells[payload.n], 'source', payload.source);
            },
            clearOutput (state, payload) {
                Vue.set(state.cells[payload.n], 'outputs', []);
            },
            addOutput (state, payload) {
                state.cells[payload.n].outputs.push(payload.out);
            },
        }
    });
    var app = new Vue({
        el: '#app',
        store,
        data: {
            opts: { lineNumbers: true }
        },
        computed: {
            txt() {
                return this.getcell().source;
            },
            out() {
                return this.getcell().outputs;
            },
            notebook() {
                return this.$store.state;
            }
        },
        methods: {
            handleInput (event) {
                this.setSource(event.id, event.value);
            },
            handleAction (event) {
                var action = event.action;
                if (action === 'eval') {
                    this.addOutput(event.id, { type:'stdout', contents:'42' });
                } else {
                    console.log("Unknown action", action, event.id);
                }
            },
            setSource (n, source) {
                this.$store.commit('setSource', {n, source});
            },
            addOutput (n, out) {
                this.$store.commit('addOutput', {n, out});
            },
            getcell() {
                return this.$store.state.cells[0];
            },
        }
    });
    window.app = app;
    window.store = store;
});

//            out: [
//                { type:'stdout', contents:'some normal stdout output'},
//                { type:'stderr', contents:'ERROR that did not work'}
//            ],

</script>
</body>
</html>
