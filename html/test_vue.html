<!DOCTYPE html>
<html>
<head>
<title>Test of VueJS Notebook</title>
<script defer src="codemirror/codemirror.js"></script>
<link rel="stylesheet" href="codemirror/codemirror.css">
<script defer src="codemirror/python.js"></script>
<style>
.cell {
    border: 1px solid #000;
}
.codemirror {
    border: 1px solid #000;
}
.output {
    background-color: #fffcfa;
    border: 2px solid #888;
    height: auto;
}
.evaloutput {
    background-color: #fafcff;
    border: 2px solid #888;
    height: auto;
}
.stdout {
}
.stderr {
    background-color: #ff0;
}
.eval {
}
pre {
    white-space: pre-wrap;
    word-break: break-all;
    margin: 0;
}

</style>
</head>
<body>


<div id="app">
    {{notebook}}    
    <cell
        v-model:value="txt"
        v-bind:startvalue="txt"
        v-bind:output="out"
    >
    </cell>
</div>

<script defer src="vue.js"></script>
<script defer src="vuex.js"></script>

<script>

function onready(f) {
    if (window.onload) {
        var curronload = window.onload;
        var newonload = function(evt) {
            curronload(evt);
            f(evt);
        };
        window.onload = newonload;
    } else {
        window.onload = f;
    }
}

onready(function() {
    Vue.component('codemirror', {
        data: function() {
            return {
                value: this.startvalue,
            };
        },
        props: ['options', 'startvalue'],
        template: String.raw`
            <div class="codemirror">
                <textarea></textarea>
            </div>`,
        mounted: function() {
            var self = this;
            var elem = self.$el.querySelector('textarea');
            self.editor = CodeMirror.fromTextArea(elem, self.options);
            self.editor.setValue(self.value || '');
            self.editor.on('change', function(cm) {
                self.value = cm.getValue();
                self.$emit('change', self.value);
                self.$emit('input', self.value);
            });
            self.editor.setOption('extraKeys', {
                'Ctrl-Enter': function(cm) {
                    console.log('Kernel is busy');
                    self.$emit('eval', self.value);
                },
            });
        },
        watch: {
            value: function(v) {
                var currentValue = this.editor.getValue();
                if (currentValue !== v) {
                    this.editor.setValue(v);
                }
            },
        },
    });
    Vue.component('celloutput', {
        props: ['values'],
        template: String.raw`
<div class="output">
    <pre v-for="value in values" :class="value.type">{{ value.contents }}</pre>
</div>
`
    });
    Vue.component('cell', {
        data: function() {
            return {
                value: this.startvalue,
            };
        },
        props: ['startvalue', 'output'],
        template: String.raw`
            <div class="cell">
                <codemirror
                    v-model:value="value"
                    v-bind:startvalue="startvalue"
                >
                </codemirror>
                <celloutput
                    v-bind:values="output"
                >
                </celloutput>
            </div>`,
    });
    const store = new Vuex.Store({
        state: {
            cells: [
                {
                    cell_type: 'code',
                    execution_count: 1,
                    source: '# some python code here\n2 + 2\n',
                    outputs: [],
                }
            ],
        },
        mutations: {
            setSource (state, payload) {
                state.cells[payload.n].source = payload.source;
            }
        }
    });
    var app = new Vue({
        el: '#app',
        store,
        data: {
            txt: '# put some Python code here\n',
            opts: { lineNumbers: true },
            out: [
                { type:'stdout', contents:'some normal stdout output'},
                { type:'stderr', contents:'ERROR that did not work'}
            ],
        },
        computed: {
            notebook() {
                return this.$store.state;
            }
        },
        methods: {
            setSource (state, n, source) {
                this.$store.commit('setSource', {n, source});
            }
        }
    });
    window.app = app;
    window.store = store;
});

</script>
</body>
</html>
